name: ğŸš€ Simple CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  basic-checks:
    name: ğŸ” Basic Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: ğŸ“¦ Cache Rust dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸ¨ Check Rust formatting
      run: |
        if [ -d "backend" ]; then
          cd backend && cargo fmt -- --check
        else
          echo "Backend directory not found, skipping Rust checks"
        fi

    - name: ğŸ“ Rust Clippy
      run: |
        if [ -d "backend" ]; then
          cd backend && cargo clippy -- -D warnings
        else
          echo "Backend directory not found, skipping Clippy"
        fi

  frontend-checks:
    name: ğŸ¨ Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ“¦ Install frontend dependencies
      run: |
        if [ -d "frontend" ]; then
          cd frontend && npm ci
        else
          echo "Frontend directory not found, skipping frontend checks"
        fi

    - name: ğŸ§ª Run frontend tests
      run: |
        if [ -d "frontend" ]; then
          cd frontend && npm test -- --coverage --watchAll=false
        else
          echo "Frontend directory not found, skipping tests"
        fi

  backend-tests:
    name: ğŸ§ª Backend Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        rust-version: [stable, beta]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ¦€ Setup Rust ${{ matrix.rust-version }}
      uses: dtolnay/rust-toolchain@master
      with:
        toolchain: ${{ matrix.rust-version }}

    - name: ğŸ“¦ Cache dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          backend/target
        key: ${{ runner.os }}-${{ matrix.rust-version }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: ğŸ§ª Run backend tests
      run: |
        if [ -d "backend" ]; then
          cd backend && cargo test --verbose
        else
          echo "Backend directory not found, skipping backend tests"
        fi

  integration-tests:
    name: ğŸ”— Integration Tests
    runs-on: ubuntu-latest
    needs: [basic-checks, frontend-checks]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: ğŸ§ª Run integration tests
      run: |
        echo "âœ… Integration tests placeholder - would run actual tests here"
        echo "ğŸ“Š All basic checks passed successfully"

  security-basic:
    name: ğŸ›¡ï¸ Basic Security
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ” Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'table'

    - name: âœ… Security check completed
      run: echo "ğŸ›¡ï¸ Basic security scan completed"